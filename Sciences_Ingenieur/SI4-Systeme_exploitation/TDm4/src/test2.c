#include <pthread.h>
#include <semaphore.h>

#include <stdlib.h>
#include <stdio.h>

sem_t sem_write_1, sem_write_2, sem_write_3;

void* thread_1(void* arg){
    int i = 1;
    int j;

    for(j = 0; j < 10; j++)
    {   
        if(sem_wait(&sem_write_1)==-1){ perror("down write"); exit(1); }
        printf("Affichage %d du thread %d\n", j+1, i);
        if(sem_post(&sem_write_2)==-1){ perror("up read"); exit(1); }
    }

    return NULL;
}

void* thread_2(void* arg){
    int i = 2;
    int j;

    for(j = 0; j < 10; j++)
    {   
        if(sem_wait(&sem_write_2)==-1){ perror("down write"); exit(1); }
        printf("Affichage %d du thread %d\n", j+1, i);
        if(sem_post(&sem_write_3)==-1){ perror("up read"); exit(1); }
    }

    return NULL;
}

void* thread_3(void* arg){
    int i = 3;
    int j;

    for(j = 0; j < 10; j++)
    {   
        if(sem_wait(&sem_write_3)==-1){ perror("down write"); exit(1); }
        printf("Affichage %d du thread %d\n", j+1, i);
        if(sem_post(&sem_write_1)==-1){ perror("up read"); exit(1); }
    }

    return NULL;
}

int main(){
    pthread_t id_t1, id_t2, id_t3;

    if(sem_init(&sem_write_1, 0, 1)==-1){ perror("init sem_write_1"); exit(1); }
    if(sem_init(&sem_write_2, 0, 0)==-1){ perror("init sem_write_2"); exit(1); }
    if(sem_init(&sem_write_3, 0, 0)==-1){ perror("init sem_write_3"); exit(1); }

    if(pthread_create(&id_t1, NULL, thread_1, NULL)!=0){ perror("create thread_1"); exit(1); }
    if(pthread_create(&id_t2, NULL, thread_2, NULL)!=0){ perror("create thread_2"); exit(1); }
    if(pthread_create(&id_t3, NULL, thread_3, NULL)!=0){ perror("create thread_3"); exit(1); }

    if(pthread_join(id_t1, NULL)==-1){ perror("join thread_1"); exit(1); }
    if(pthread_join(id_t2, NULL)==-1){ perror("join thread_2"); exit(1); }
    if(pthread_join(id_t3, NULL)==-1){ perror("join thread_3"); exit(1); }

    if(sem_destroy(&sem_write_1)==-1){ perror("destroy sem_write_1"); exit(1); }
    if(sem_destroy(&sem_write_2)==-1){ perror("destroy sem_write_2"); exit(1); }
    if(sem_destroy(&sem_write_3)==-1){ perror("destroy sem_write_3"); exit(1); }

    return 0;
}