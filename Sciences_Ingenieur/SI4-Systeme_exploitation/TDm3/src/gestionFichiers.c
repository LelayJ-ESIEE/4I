#include "../include/gestionFichiers.h"

char * litLigne(int fd)
{
	int i;
	int nbr;
	char buf[TAILLEBUF];
	char * s;

	for(nbr = 0 ; nbr < TAILLEBUF ; nbr++){
		int rc = read(fd, buf+nbr,1);
		if( rc == 0  ){
			return NULL;
		}
		if(rc== -1){
			perror("erreur de lecture dans litLigne");
			exit(1);
		}

		if(buf[nbr]=='\n')break;
	} 

	s=(char*)malloc(nbr+1);
	if(s==NULL){
		perror("allocation issue in litLigne");
		return NULL;
	}

	for(i=0;i<nbr;i++)
		s[i]=buf[i];
	s[i] = '\0';
	return s;
}

/* retourne -1 en cas d'echec, taille de la chaine sinon*/
int ecritLigne(char* chaine,int fd)
{

	int size_s = strlen(chaine);
	int nbw=0;
	int tmp;

	while(nbw!=size_s){
		tmp = write(fd,chaine+nbw,size_s-nbw);
		if(tmp==-1){
			perror("write issue in ecritLigne");
			return -1;
		}
		nbw+=tmp;
	}
	tmp = write(fd,"\n",1);
	if(tmp==-1){
		perror("write issue in ecritLigne");
		return -1;
	}
	return nbw;

}

void rw(int fdin, int fdout){
    char * s = litLigne(fdin);
    int r;
	printf("read\n");

    while (s != NULL)
    {
        r = ecritLigne(s, fdout);
		printf("writen\n");
		free(s);
        if(r < 0) exit(r);
        s = litLigne(fdin);
		printf("read\n");
    }
    
}
