#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include "../include/gestionFichiers.h"

int main(){
    int r;
    int fds[2];
    /* create pipe */
    r = pipe(fds);
    if(r == -1){
        perror("error while creating pipe");
        exit(1);
    }
    /* fork */
    r = fork();
    if(r == -1){
        perror("error while forking");
        exit(1);
    }
    /* parent : */
    if(r != 0){
        int fd;

        printf("parent - %d", getpid());

        r = close(fds[0]);
        if(r == -1){
            perror("error while closing reading fd of pipe in parent");
            exit(1);
        }

        fd = open("src.txt",O_RDONLY);
        if(fd == -1){
            perror("error while opening src.txt");
            exit(1);
        }

        rw(fd, fds[1]);

        r = close(fds[1]);
        if(r == -1){
            perror("error while closing writing fd of pipe in parent");
            exit(1);
        }
        r = close(fd);
        if(r == -1){
            perror("error while closing src.txt fd");
            exit(1);
        }
    }

    /* child */
    else{
        int fd;
        
        printf("child - %d", getpid());
        
        r = close(fds[1]);
        if(r == -1){
            perror("error while closing writing fd of pipe in child");
            exit(1);
        }

        fd = open("dst.txt",O_CREAT|O_WRONLY|O_TRUNC, S_IRWXU);
        if(fd == -1){
            perror("error while opening dst.txt");
            exit(1);
        }

        rw(fds[0], fd);

        r = close(fds[0]);
        if(r == -1){
            perror("error while closing reading fd of pipe in child");
            exit(1);
        }
        r = close(fd);
        if(r == -1){
            perror("error while closing dst.txt fd");
            exit(1);
        }
    }

    return 0;
}