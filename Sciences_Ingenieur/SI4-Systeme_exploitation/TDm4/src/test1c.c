#include <pthread.h>
#include <semaphore.h>

#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

#include <string.h>
#include <stdio.h>

#include "../include/gestionFichiers.h"

#define MAX 1000

char buffer[MAX];
sem_t sem_read, sem_write;

void* thread_reader(void* arg){
    int fd;

    if( (fd=open("src.txt", O_RDONLY)) ==-1){ perror("ouverture src.txt"); exit(1); }

    while(1){
        char* s = litLigne(fd);
        if(sem_wait(&sem_read)==-1){ perror("down read"); exit(1); }
        if(s==NULL){
            buffer[0] = EOF;
            if(sem_post(&sem_write)==-1){ perror("up write"); exit(1); }
            break;
        }
        strcpy(buffer, s);
        if(sem_post(&sem_write)==-1){ perror("up write"); exit(1); }
        free(s);
    }

    if(close(fd) ==-1){ perror("fermeture src.txt"); exit(1); }
        
    return NULL;
}

void* thread_writer(void* arg){
    int fd;

    if( (fd=open("dst.txt", O_CREAT|O_WRONLY|O_TRUNC)) ==-1){ perror("ouverture dst.txt"); exit(1); }

    while(1){
        if(sem_wait(&sem_write)==-1){ perror("down write"); exit(1); }
        if(buffer[0]==EOF) break;
        ecritLigne(buffer, fd);
        if(sem_post(&sem_read)==-1){ perror("up read"); exit(1); }
    }

    if(close(fd) ==-1){ perror("fermeture dst.txt"); exit(1); }
        
    return NULL;
}

int main(){
    pthread_t id_reader, id_writer;

    if(sem_init(&sem_write, 0, 0)==-1){ perror("init write"); exit(1); }
    if(sem_init(&sem_read, 0, 1)==-1){ perror("init read"); exit(1); }

    if(pthread_create(&id_reader, NULL, thread_reader, NULL)!=0){ perror("create thread_reader"); exit(1); }
    if(pthread_create(&id_writer, NULL, thread_writer, NULL)!=0){ perror("create thread_writer"); exit(1); }

    if(pthread_join(id_reader, NULL)==-1){ perror("join thread_read"); exit(1); }
    if(pthread_join(id_writer, NULL)==-1){ perror("join thread_writer"); exit(1); }

    if(sem_destroy(&sem_write)==-1){ perror("destroy write"); exit(1); }
    if(sem_destroy(&sem_read)==-1){ perror("destroy read"); exit(1); }

    return 0;
}

/*
Problèmes relevés :
    pas concurrent ==> Buffer trop petit = pas d'écriture
*/