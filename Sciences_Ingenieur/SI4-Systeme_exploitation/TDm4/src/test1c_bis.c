#include <pthread.h>
#include <semaphore.h>

#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

#include <string.h>
#include <stdio.h>

#include "../include/gestionFichiers.h"

#define MAX 1000
#define MAX_LOCAL 100

char buffer[MAX];
sem_t sem_read, sem_write;

void* thread_reader(void* arg){
    int fd;
    int pos = 0;
    int i;

    if( (fd=open("src.txt", O_RDONLY)) ==-1){
        perror("ouverture src.txt");
        exit(1);
    }

    while(1){
        char* s = litLigne(fd);
        
        if(s==NULL){
            if(sem_wait(&sem_read)==-1){ perror("down read"); exit(1); }
            buffer[0] = EOF;
            if(sem_post(&sem_write)==-1){ perror("up write"); exit(1); }
            break;
        }

        for(i=0; s[i] != '\0'; i++){
            if(sem_wait(&sem_read)==-1){ perror("down read"); exit(1); }
            buffer[pos] = s[i];
            if(sem_post(&sem_write)==-1){ perror("up write"); exit(1); }
            pos = (pos+1) % MAX;
        }

        if(sem_wait(&sem_read)==-1){ perror("down read"); exit(1); }
        buffer[pos] = s[i];
        if(sem_post(&sem_write)==-1){ perror("up write"); exit(1); }
        pos = (pos+1) % MAX;
        
        free(s);
    }

    if(close(fd) ==-1){
        perror("fermeture src.txt");
        exit(1);
    }
        
    return NULL;
}

void* thread_writer(void* arg){
    int fd;
    char buf_local[MAX_LOCAL];
    int pos = 0;
    int pos_local = 0;

    if( (fd=open("dst.txt", O_CREAT|O_WRONLY|O_TRUNC)) ==-1){
        perror("ouverture dst.txt");
        exit(1);
    }

    while(1){
        if(sem_wait(&sem_write)==-1){
            perror("down write");
            exit(1);
        }
        buf_local[pos_local] = buffer[pos];
        if(sem_post(&sem_read)==-1){
            perror("up read");
            exit(1);
        }
        pos = (pos+1)%MAX;

        if(buffer[0]==EOF) break;
        if(buf_local[pos_local] == '\0'){
            ecritLigne(buf_local, fd);
            pos_local=0;
        }
        else
            pos_local++;
    }
        
    if(close(fd) ==-1){
        perror("fermeture dst.txt");
        exit(1);
    }

    return NULL;
}

int main(){
    pthread_t id_reader, id_writer;

    if(sem_init(&sem_write, 0, 0)==-1){
        perror("init write");
        exit(1);
    }

    if(sem_init(&sem_read, 0, MAX)==-1){
        perror("init read");
        exit(1);
    }

    if(pthread_create(&id_reader, NULL, thread_reader, NULL)!=0){
        perror("create thread_reader");
        exit(1);
    }

    if(pthread_create(&id_writer, NULL, thread_writer, NULL)!=0){
        perror("create thread_writer");
        exit(1);
    }

    if(pthread_join(id_reader, NULL)==-1){
        perror("join thread_read");
        exit(1);
    }

    if(pthread_join(id_writer, NULL)==-1){
        perror("join thread_writer");
        exit(1);
    }

    if(sem_destroy(&sem_write)==-1){
        perror("destroy write");
        exit(1);
    }

    if(sem_destroy(&sem_read)==-1){
        perror("destroy read");
        exit(1);
    }

    return 0;
}

/*
Problèmes relevés :
    pas concurrent ==> Buffer trop petit = pas d'écriture
*/